name: Order Submission Orchestration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run against'
        required: true
        type: choice
        options:
          - dev
          - staging
        default: 'dev'
      
      product_plan:
        description: 'Product Plan'
        required: false
        type: choice
        options:
          - base_plan_basic
          - base_plan_better
          - base_plan_max
          - base_plan_unlimited
        default: 'base_plan_basic'
  
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'package.json'
      - '.github/workflows/**'

jobs:
  orchestrate:
    name: Run Order Orchestration
    runs-on: ubuntu-latest
    
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create .env file
        run: |
          cat << EOF > .env
          NODE_ENV=${{ github.event.inputs.environment || 'dev' }}
          API_BASE_URL=${{ secrets.API_BASE_URL }}
          PAYMENT_BASE_URL=${{ secrets.PAYMENT_BASE_URL }}
          USR_PSWD_IO=${{ secrets.USR_PSWD_IO }}
          EOF
          chmod 600 .env
      
      - name: Run TypeScript type check
        run: npx tsc --noEmit
      
      - name: Run orchestration
        id: orchestrate
        run: npm start
        env:
          CI: true
        timeout-minutes: 15
        continue-on-error: true
      
      - name: Upload orchestration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: orchestration-logs-${{ github.run_number }}
          path: |
            logs/
            orchestration-*.log
          retention-days: 7
          if-no-files-found: warn
      
      - name: Clean up sensitive files
        if: always()
        run: |
          rm -f .env
          rm -f tokenStore.json
      
      - name: Check orchestration result
        if: steps.orchestrate.outcome == 'failure'
        run: |
          echo "::error::Orchestration failed! Check logs for details."
          exit 1
      
      - name: Success summary
        if: steps.orchestrate.outcome == 'success'
        run: |
          echo "::notice::âœ… Orchestration completed successfully!"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Product Plan: ${{ github.event.inputs.product_plan || 'base_plan_basic' }}"
